#include <ESP8266WiFi.h>
#include <ESP8266WebServer.h>
#include <SoftwareSerial.h>
#include <ESP8266HTTPClient.h>
#include <WiFiClientSecureBearSSL.h>
#include <ArduinoJson.h>

// ===================== CONFIG =====================
//const char* WIFI_SSID = "Cargo8788";
//const char* WIFI_PASS = "87882023Bc";
//const char* WIFI_SSID = "Link-27";
//const char* WIFI_PASS = "L12345678a";

const char* WIFI_SSID = "Beeline_900B";
const char* WIFI_PASS = "D318900B";
const char* POLL_BASE_URL = "https://lasers.drawbridge.kz/api/v1/poll";
const bool  POLL_TLS_INSECURE = true; // отключить проверку сертификата
const int   POLL_WAIT_SECS = 15;

String DEVICE_ID = "113km"; // можно задать вручную или собрать из ChipID

// ==== UART к Mega ====
// D7 -> Mega RX2(17), D6 <- Mega TX2(16)
SoftwareSerial megaSerial(D6, D7); // RX, TX

// ==== HTTP & WiFi ====
ESP8266WebServer server(80);
unsigned long g_lastPollAt = 0;
unsigned long g_nextPollAt = 0;
int g_backoffMs = 1000;
int g_lastHttpCode = 0;
String g_pollCursor = "";
unsigned long g_lastPollOkAt = 0;

// ===================== Wi-Fi helpers =====================
void wifiConnectIfNeeded() {
  if (WiFi.status() == WL_CONNECTED) return;
  Serial.print("[WiFi] Connecting to "); Serial.println(WIFI_SSID);
  WiFi.mode(WIFI_STA);
  WiFi.begin(WIFI_SSID, WIFI_PASS);
  unsigned long t0 = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - t0 < 20000) {
    delay(300);
    Serial.print(".");
  }
  Serial.println();
  if (WiFi.status() == WL_CONNECTED) {
    Serial.print("[WiFi] Connected. IP: "); Serial.println(WiFi.localIP());
  } else {
    Serial.println("[WiFi] Failed. Will retry.");
  }
}

// ===================== JSON PARSE =====================
void applyEvent(JsonVariant ev) {
  if (!ev.is<JsonObject>()) return;
  JsonObject o = ev.as<JsonObject>();
  String cmd = o.containsKey("cmd") ? String((const char*)o["cmd"]) : "";
  String args = o.containsKey("args") ? String((const char*)o["args"]) : "";
  cmd.trim(); args.trim();

  if (cmd.length()) {
    String full = cmd;
    if (args.length()) full += " " + args;

    // Отправляем на Mega
    megaSerial.println(full);
    Serial.println("[→ MEGA] " + full);
  }
}

bool processPollPayload(const String& body) {
  DynamicJsonDocument doc(4096);
  DeserializationError e = deserializeJson(doc, body);
  if (e) {
    Serial.print("[POLL] JSON parse error: "); Serial.println(e.c_str());
    return false;
  }

  if (doc.is<JsonObject>()) {
    JsonObject o = doc.as<JsonObject>();
    if (o.containsKey("events")) {
      JsonArray arr = o["events"].as<JsonArray>();
      for (JsonVariant v : arr) applyEvent(v);
    } else if (o.containsKey("cmd")) {
      applyEvent(o);
    }
    if (o.containsKey("cursor")) g_pollCursor = String((const char*)o["cursor"]);
  } else if (doc.is<JsonArray>()) {
    JsonArray arr = doc.as<JsonArray>();
    for (JsonVariant v : arr) applyEvent(v);
  }
  return true;
}

// ===================== Long-poll =====================
bool longPollOnce() {
  if (WiFi.status() != WL_CONNECTED) return false;

  // URL
  String url = String(POLL_BASE_URL) + "?device=" + DEVICE_ID;
  if (g_pollCursor.length()) url += "&cursor=" + g_pollCursor;
  url += "&wait=" + String(POLL_WAIT_SECS);

  std::unique_ptr<BearSSL::WiFiClientSecure> httpsClient(new BearSSL::WiFiClientSecure);
  if (POLL_TLS_INSECURE) httpsClient->setInsecure();
  httpsClient->setTimeout((POLL_WAIT_SECS + 5) * 1000);

  HTTPClient http;
  http.setReuse(true);
  http.setTimeout((POLL_WAIT_SECS + 5) * 1000);

  Serial.println("[POLL] GET " + url);

  bool began = http.begin(*httpsClient, url);
  if (!began) {
    Serial.println("[POLL] http.begin() failed");
    return false;
  }

  http.addHeader("Accept", "application/json");
  int code = http.GET();
  g_lastHttpCode = code;
  bool ok = false;

  if (code > 0) {
    if (code == HTTP_CODE_OK) {
      String payload = http.getString();
      Serial.printf("[POLL] 200 OK (%u bytes)\n", payload.length());
      Serial.println("[POLL] " + payload);
      ok = processPollPayload(payload);
      if (ok) g_lastPollOkAt = millis();
    } else if (code == HTTP_CODE_NO_CONTENT) {
      Serial.println("[POLL] 204 No Content");
      ok = true;
      g_lastPollOkAt = millis();
    } else {
      Serial.printf("[POLL] HTTP %d\n", code);
    }
  } else {
    Serial.printf("[POLL] http error: %s\n", http.errorToString(code).c_str());
  }

  http.end();
  return ok;
}

void longPollTick() {
  unsigned long now = millis();
  if (now < g_nextPollAt) return;

  if (WiFi.status() != WL_CONNECTED) {
    wifiConnectIfNeeded();
    g_nextPollAt = millis() + 1000;
    return;
  }

  bool ok = longPollOnce();
  if (ok) {
    g_backoffMs = 1000;
    g_nextPollAt = millis() + 50;
  } else {
    g_backoffMs = min(g_backoffMs * 2, 30000);
    g_nextPollAt = millis() + g_backoffMs;
  }
}

// ===================== Web UI =====================
void handleRoot() {
  String html = "<html><body><h2>Wemos → Mega DMX</h2>";
  html += "<p>Device: <b>" + DEVICE_ID + "</b></p>";
  html += "<p>WiFi IP: " + WiFi.localIP().toString() + "</p>";
  html += "<p>Last HTTP: " + String(g_lastHttpCode) + "</p>";
  html += "<p>Last poll OK at: " + String(g_lastPollOkAt) + " ms</p>";
  html += "<p>Cursor: " + g_pollCursor + "</p>";
  html += "<hr><p>Send test command:</p>";
  html += "<form action='/send' method='get'><input name='cmd'><button>Send</button></form>";
  html += "</body></html>";
  server.send(200, "text/html", html);
}

void handleSend() {
  if (server.hasArg("cmd")) {
    String c = server.arg("cmd");
    c.trim();
    if (c.length()) {
      megaSerial.println(c);
      Serial.println("[TEST] Sent to Mega: " + c);
    }
  }
  server.sendHeader("Location", "/");
  server.send(303);
}

// ===================== setup/loop =====================
void setup() {
  Serial.begin(115200);
  megaSerial.begin(9600);
  WiFi.mode(WIFI_STA);
  WiFi.hostname(DEVICE_ID);
  wifiConnectIfNeeded();

  server.on("/", handleRoot);
  server.on("/send", handleSend);
  server.begin();

  Serial.println("[HTTP] Web server started on port 80");
  Serial.print("[WiFi] IP: "); Serial.println(WiFi.localIP());
  Serial.println("[UART] D6→RX2, D7→TX2");

  g_nextPollAt = millis() + 1000;
}

void loop() {
  server.handleClient();
  longPollTick();
}
